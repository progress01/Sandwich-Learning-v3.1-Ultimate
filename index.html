<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sandwich v5.0 - åœ–æ–‡è¨˜æ†¶å­¸ç¿’</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5; /* ä¸»è‰²èª¿ï¼šé›è— */
            --primary-bg: #eef2ff;
            --text-main: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --bg-body: #f9fafb;
            
            /* å­¸ç¿’æ¨¡å¼é¡è‰² */
            --cloze-bg-hint: #fef3c7; /* æç¤ºæ¨¡å¼åº•è‰² (é»ƒ) */
            --cloze-text-hint: #92400e;
            --cloze-bg-hide: #cbd5e1; /* è¤‡ç¿’æ¨¡å¼åº•è‰² (ç°) */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; padding: 0; 
            font-family: 'Inter', 'Noto Sans TC', sans-serif; 
            background: var(--bg-body); color: var(--text-main); 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; 
        }

        /* --- 1. é ‚éƒ¨å·¥å…·åˆ— (Toolbar) --- */
        .toolbar {
            height: 56px; background: white; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 12px; z-index: 50; flex-shrink: 0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .brand { 
            font-weight: 800; font-size: 1.1rem; color: var(--primary); 
            display: flex; align-items: center; gap: 6px; 
            cursor: pointer;
        }

        /* éšæ®µåˆ‡æ›æŒ‰éˆ•çµ„ */
        .stage-tabs { 
            display: flex; background: #f3f4f6; padding: 3px; border-radius: 8px; gap: 2px; 
        }
        .stage-btn {
            padding: 6px 10px; border-radius: 6px; border: none; background: transparent;
            font-size: 0.85rem; font-weight: 600; color: #666; cursor: pointer; transition: 0.2s;
        }
        .stage-btn.active { background: white; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .stage-btn.active-3 { color: #dc2626; } /* è¤‡ç¿’æ¨¡å¼äº®ç´…ç‡ˆ */

        /* å³å´å·¥å…· */
        .tools-right { display: flex; align-items: center; gap: 8px; }
        .icon-btn {
            width: 36px; height: 36px; border-radius: 8px; border: 1px solid transparent;
            background: transparent; display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem; cursor: pointer; color: #374151; transition: 0.2s;
        }
        .icon-btn:hover { background: #f3f4f6; }
        .icon-btn.primary { background: var(--primary-bg); color: var(--primary); }

        /* --- 2. ä¸»ç•«é¢ä½ˆå±€ --- */
        .workspace { flex: 1; display: flex; overflow: hidden; position: relative; }

        /* å´é‚Šæ¬„ (æ–‡ç« åˆ—è¡¨) - æ‰‹æ©Ÿç‰ˆé è¨­éš±è— */
        .sidebar {
            width: 260px; background: white; border-right: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 100;
            position: absolute; top: 0; bottom: 0; left: 0;
            transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 10px 0 25px rgba(0,0,0,0.1);
        }
        .sidebar.open { transform: translateX(0); }
        
        /* å´é‚Šæ¬„é®ç½© */
        .sidebar-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 90; 
            display: none; backdrop-filter: blur(2px);
        }
        .sidebar-overlay.show { display: block; }

        .sidebar-header {
            padding: 16px; border-bottom: 1px solid var(--border);
            font-weight: bold; color: var(--text-light); display: flex; justify-content: space-between; align-items: center;
        }
        .doc-list { overflow-y: auto; flex: 1; padding: 10px; }
        .doc-item {
            padding: 12px; background: white; border: 1px solid var(--border); border-radius: 8px;
            margin-bottom: 8px; font-size: 0.95rem; cursor: pointer; transition: 0.1s;
        }
        .doc-item:active { transform: scale(0.98); }
        .doc-item.active { border-left: 4px solid var(--primary); background: var(--primary-bg); border-color: #c7d2fe; }

        /* --- 3. ç·¨è¼¯å™¨æ ¸å¿ƒå€åŸŸ --- */
        .editor-container {
            flex: 1; display: flex; flex-direction: column; background: white; width: 100%; position: relative;
        }
        
        #titleInput {
            font-size: 1.2rem; border: none; border-bottom: 1px solid var(--border);
            padding: 16px 20px; width: 100%; outline: none; font-weight: 800;
            background: white; border-radius: 0;
        }

        .editor-scroll {
            flex: 1; overflow-y: auto; padding: 20px; 
            -webkit-overflow-scrolling: touch; /* iOS æ»¾å‹•å„ªåŒ– */
        }

        #editor {
            font-size: 1.15rem; line-height: 1.8; outline: none; 
            min-height: 60vh; white-space: pre-wrap; color: var(--text-main);
            max-width: 800px; margin: 0 auto; padding-bottom: 100px;
        }
        #editor:empty::before { content: 'åœ¨æ­¤è¼¸å…¥æ–‡å­—ï¼Œæˆ–è²¼ä¸Šåœ–ç‰‡...'; color: #9ca3af; }

        /* --- 4. è¡Œå…§åœ–ç‰‡ (Inline Image) æ¨£å¼ --- */
        .inline-img-wrapper {
            display: block; margin: 15px auto; text-align: center;
            position: relative; max-width: 100%; border-radius: 8px; overflow: hidden;
            border: 1px solid #f3f4f6; background: #fafafa;
        }
        .inline-img-wrapper img {
            max-width: 100%; height: auto; display: block; margin: 0 auto;
            max-height: 400px; transition: filter 0.3s ease, opacity 0.3s ease;
        }
        
        /* åˆªé™¤æŒ‰éˆ• */
        .img-del-btn {
            position: absolute; top: 8px; right: 8px;
            background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%;
            width: 28px; height: 28px; font-size: 16px; cursor: pointer;
            display: none; align-items: center; justify-content: center;
        }
        /* åƒ…åœ¨ç·¨è¼¯æ¨¡å¼é¡¯ç¤ºåˆªé™¤éˆ• */
        body.mode-1 .inline-img-wrapper:hover .img-del-btn { display: flex; }

        /* è¤‡ç¿’æ¨¡å¼ (Mode 3) - åœ–ç‰‡æ¨¡ç³Šé®ç½© */
        body.mode-3 .inline-img-wrapper img {
            filter: blur(12px) grayscale(0.8);
            opacity: 0.6;
        }
        body.mode-3 .inline-img-wrapper::after {
            content: 'ğŸ‘ï¸'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 2.5rem; color: rgba(0,0,0,0.4); pointer-events: none;
        }
        /* é»æ“Šæˆ–æ‡¸åœæ­æ›‰ */
        body.mode-3 .inline-img-wrapper:hover img,
        body.mode-3 .inline-img-wrapper:active img {
            filter: none; opacity: 1;
        }
        body.mode-3 .inline-img-wrapper:hover::after,
        body.mode-3 .inline-img-wrapper:active::after { display: none; }


        /* --- 5. æŒ–ç©ºæ–‡å­— (Cloze) æ¨£å¼ --- */
        .cloze-word {
            border-bottom: 2px solid #94a3b8; border-radius: 4px; padding: 0 3px; 
            cursor: pointer; display: inline-block; min-width: 2em; text-align: center;
            transition: all 0.2s; margin: 0 1px;
        }

        /* Mode 1: ç·¨è¼¯ */
        body.mode-1 .cloze-word { background: #f3f4f6; color: black; }
        body.mode-1 .cloze-word:hover { background: #e5e7eb; }
        
        /* Mode 2: æç¤º (Hint) */
        body.mode-2 .cloze-word { 
            background: var(--cloze-bg-hint); color: var(--cloze-text-hint); 
            font-weight: bold; border-bottom: none; position: relative; 
        }
        body.mode-2 .cloze-word:not([data-hint]) { background: var(--border); color: transparent; }
        body.mode-2 .cloze-word[data-hint] { color: transparent; }
        body.mode-2 .cloze-word[data-hint]::before {
            content: attr(data-hint); position: absolute; inset: 0;
            display: flex; align-items: center; justify-content: center;
            color: var(--cloze-text-hint); pointer-events: none; font-size: 0.9em;
        }

        /* Mode 3: å…¨é® (Test) */
        body.mode-3 .cloze-word { 
            background: var(--cloze-bg-hide); color: transparent; border: none; user-select: none; 
        }

        /* æ­æ›‰ç‹€æ…‹ (Mode 2 & 3) */
        .cloze-word.revealed { 
            background: #dbeafe !important; color: #1e40af !important; 
            font-weight: bold; animation: popIn 0.2s; 
        }
        .cloze-word.revealed::before { display: none; } /* éš±è—æç¤º */
        
        @keyframes popIn { 0% { transform: scale(0.9); } 100% { transform: scale(1); } }


        /* --- 6. å­—å…¸åº•éƒ¨æ»‘æ¿ (Bottom Sheet) --- */
        #dict-sheet {
            position: fixed; bottom: 0; left: 0; right: 0; background: white;
            border-top-left-radius: 16px; border-top-right-radius: 16px;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.15); z-index: 2000;
            transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            max-height: 85vh; display: flex; flex-direction: column;
        }
        #dict-sheet.open { transform: translateY(0); }
        
        .sheet-handle { 
            width: 40px; height: 5px; background: #e5e7eb; border-radius: 3px; 
            margin: 10px auto; flex-shrink: 0; 
        }
        .dict-content { padding: 0 20px 20px 20px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        
        .dict-word-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .dict-word { font-size: 1.6rem; font-weight: 800; color: #111; }
        .dict-phonetic { color: #666; font-family: sans-serif; margin-left: 10px; }
        
        .dict-def-block { margin-top: 15px; font-size: 1rem; line-height: 1.6; }
        .dict-def-item { margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dashed #eee; }
        .dict-pos { color: var(--primary); font-weight: bold; margin-right: 5px; }

        .dict-actions { display: flex; gap: 10px; margin-top: 20px; }
        .action-btn { 
            flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #e5e7eb; 
            background: white; font-weight: 600; font-size: 0.95rem; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .action-btn:active { background: #f3f4f6; }

        /* é›»è…¦ç‰ˆé©é… */
        @media screen and (min-width: 769px) {
            .sidebar { position: static; transform: none; box-shadow: none; border-right: 1px solid var(--border); }
            .sidebar-overlay { display: none !important; }
            #dict-sheet { 
                width: 360px; left: auto; right: 20px; bottom: 20px; 
                border-radius: 12px; border: 1px solid #eee;
                transform: translateY(20px); opacity: 0; pointer-events: none;
            }
            #dict-sheet.open { transform: translateY(0); opacity: 1; pointer-events: auto; }
            .sheet-handle { display: none; }
        }
    </style>
</head>
<body class="mode-1">

    <input type="file" id="imgUpload" hidden accept="image/*" onchange="handleManualUpload(this)">
    <input type="file" id="jsonUpload" hidden accept=".json" onchange="importData(this)">

    <div class="toolbar">
        <div class="brand" onclick="toggleSidebar()">
            <span style="font-size:1.4rem;">ğŸ¥ª</span> 
            <span>Sandwich</span>
        </div>
        
        <div class="stage-tabs">
            <button class="stage-btn active" id="btn-p1" onclick="setPhase(1)">1.ç·¨è¼¯</button>
            <button class="stage-btn" id="btn-p2" onclick="setPhase(2)">2.æç¤º</button>
            <button class="stage-btn" id="btn-p3" onclick="setPhase(3)">3.è¤‡ç¿’</button>
        </div>

        <div class="tools-right">
            <button class="icon-btn primary" onclick="triggerImgUpload()" title="æ’å…¥åœ–ç‰‡">ğŸ–¼ï¸</button>
            <button class="icon-btn" onclick="maskSelection()" title="æŒ–ç©º (M)">âœ‚ï¸</button>
            <button class="icon-btn" onclick="toggleSidebar()" title="é¸å–®">â˜°</button>
        </div>
    </div>

    <div class="workspace">
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                æ–‡ç« åˆ—è¡¨
                <button onclick="addNewDoc()" style="color:var(--primary); background:none; border:none; font-weight:bold; cursor:pointer; font-size:0.9rem;">ï¼‹ æ–°å¢</button>
            </div>
            <div class="doc-list" id="docList"></div>
            
            <div style="padding:15px; border-top:1px solid #eee; background:#f9fafb;">
                <div style="font-size:0.8rem; color:#888; margin-bottom:10px;">è³‡æ–™å‚™ä»½ (JSON)</div>
                <div style="display:flex; gap:10px;">
                    <button onclick="exportData()" style="flex:1; padding:8px; border:1px solid #ddd; background:white; border-radius:6px; cursor:pointer;">ğŸ“¤ åŒ¯å‡º</button>
                    <button onclick="document.getElementById('jsonUpload').click()" style="flex:1; padding:8px; border:1px solid #ddd; background:white; border-radius:6px; cursor:pointer;">ğŸ“¥ åŒ¯å…¥</button>
                </div>
            </div>
        </div>

        <div class="editor-container">
            <input id="titleInput" placeholder="åœ¨æ­¤è¼¸å…¥å–®å…ƒæ¨™é¡Œ..." oninput="saveCurrentDoc()">
            <div class="editor-scroll">
                <div id="editor" contenteditable="true" 
                     oninput="saveCurrentDoc()" 
                     onclick="handleEditorClick(event)"></div>
            </div>
        </div>
    </div>

    <div id="dict-sheet">
        <div class="sheet-handle" onclick="closeDict()"></div>
        <div class="dict-content">
            <div class="dict-word-row">
                <div>
                    <span id="dt-word" class="dict-word">Word</span>
                    <span id="dt-phonetic" class="dict-phonetic"></span>
                </div>
                <button onclick="closeDict()" style="background:#f3f4f6; border:none; width:32px; height:32px; border-radius:50%; cursor:pointer;">âœ•</button>
            </div>
            
            <div id="dt-body" class="dict-def-block"></div>

            <div class="dict-actions">
                <button class="action-btn" onclick="playAudio()" style="color:#b45309; background:#fffbeb; border-color:#fcd34d;">
                    ğŸ”Š ç™¼éŸ³
                </button>
                <button class="action-btn" onclick="searchExternal()" style="color:#374151;">
                    ğŸ–¼ï¸ Google åœ–
                </button>
            </div>
        </div>
    </div>
    
    <audio id="audio-player" hidden></audio>

    <script>
        // --- æ ¸å¿ƒè³‡æ–™ ---
        let docs = [];
        let currentId = null;
        const STORAGE_KEY = 'sandwich_v5_data';

        // --- DOM Cache ---
        const editor = document.getElementById('editor');
        const titleInput = document.getElementById('titleInput');
        
        // --- åˆå§‹åŒ– ---
        function init() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                try { docs = JSON.parse(data); } catch(e) { console.error('Data corrupted'); docs=[]; }
            }
            if (docs.length === 0) addNewDoc();
            else loadDoc(docs[0].id);

            // 1. ç›£è½è²¼ä¸Š (åœ–ç‰‡æ””æˆª)
            editor.addEventListener('paste', handlePaste);

            // 2. éµç›¤å¿«æ·éµ
            document.addEventListener('keydown', (e) => {
                if (e.key.toLowerCase() === 'm' && !e.ctrlKey && getMode() === 1) {
                    // å¦‚æœæœ‰é¸å–æ–‡å­—ï¼ŒåŸ·è¡ŒæŒ–ç©º
                    if (window.getSelection().toString().trim()) {
                        e.preventDefault();
                        maskSelection();
                    }
                }
            });

            // 3. é›™æ“ŠæŸ¥å­—å…¸ (é›»è…¦ç‰ˆ)
            editor.addEventListener('dblclick', (e) => {
                if (window.innerWidth > 768) {
                    const sel = window.getSelection();
                    const word = sel.toString().trim().replace(/[^a-zA-Z]/g, "");
                    if (word.length > 1) showDict(word);
                }
            });
        }

        // --- æ–‡æª”ç®¡ç† ---
        function addNewDoc() {
            const newDoc = { id: Date.now(), title: 'æ–°å–®å…ƒ ' + (docs.length + 1), content: '' };
            docs.unshift(newDoc);
            loadDoc(newDoc.id);
            if (window.innerWidth <= 768) toggleSidebar(false);
        }

        function loadDoc(id) {
            currentId = id;
            const doc = docs.find(d => d.id === id);
            if (!doc) return;
            
            titleInput.value = doc.title;
            editor.innerHTML = doc.content;
            renderList();
            setPhase(1); // è¼‰å…¥æ™‚å›åˆ°ç·¨è¼¯æ¨¡å¼
        }

        function saveCurrentDoc() {
            const doc = docs.find(d => d.id === currentId);
            if (doc) {
                doc.title = titleInput.value;
                doc.content = editor.innerHTML;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(docs));
                renderList(); // æ›´æ–°æ¨™é¡Œ
            }
        }

        function renderList() {
            const list = document.getElementById('docList');
            list.innerHTML = '';
            docs.forEach(d => {
                const div = document.createElement('div');
                div.className = `doc-item ${d.id === currentId ? 'active' : ''}`;
                div.innerText = d.title || 'æœªå‘½åå–®å…ƒ';
                div.onclick = () => { loadDoc(d.id); if(window.innerWidth<=768) toggleSidebar(false); };
                list.appendChild(div);
            });
        }

        // --- æŒ–ç©º (Cloze) é‚è¼¯ ---
        function maskSelection() {
            if (getMode() !== 1) { alert('è«‹åˆ‡æ›è‡³ã€Œ1.ç·¨è¼¯ã€æ¨¡å¼'); return; }
            
            const sel = window.getSelection();
            if (!sel.rangeCount || !sel.toString().trim() || !editor.contains(sel.anchorNode)) return;

            const text = sel.toString();
            const hint = prompt(`å°‡ã€Œ${text}ã€æŒ–ç©ºã€‚\n(é¸å¡«) è¼¸å…¥æç¤ºè©ï¼š`, "");
            if (hint === null) return;

            const range = sel.getRangeAt(0);
            const span = document.createElement('span');
            span.className = 'cloze-word';
            span.textContent = text;
            if (hint.trim()) span.setAttribute('data-hint', hint);

            range.deleteContents();
            range.insertNode(span);
            sel.removeAllRanges();
            saveCurrentDoc();
        }

        function handleEditorClick(e) {
            // é»æ“ŠæŒ–ç©ºå­—
            if (e.target.classList.contains('cloze-word')) {
                if (getMode() === 1) {
                    // ç·¨è¼¯æ¨¡å¼ï¼šå–æ¶ˆæŒ–ç©º
                    if(confirm(`é‚„åŸæ–‡å­—ã€Œ${e.target.innerText}ã€?`)) {
                        e.target.outerHTML = e.target.innerText;
                        saveCurrentDoc();
                    }
                } else {
                    // å­¸ç¿’æ¨¡å¼ï¼šæ­æ›‰/éš±è—
                    e.target.classList.toggle('revealed');
                }
            }
        }

        // --- åœ–ç‰‡è™•ç† (è¡Œå…§åœ–ç‰‡) ---
        function triggerImgUpload() {
            document.getElementById('imgUpload').click();
        }

        function handleManualUpload(input) {
            if (input.files && input.files[0]) {
                processImage(input.files[0]);
                input.value = '';
            }
        }

        function handlePaste(e) {
            // åµæ¸¬å‰ªè²¼ç°¿æ˜¯å¦æœ‰åœ–ç‰‡
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            let blob = null;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf("image") === 0) {
                    blob = items[i].getAsFile();
                    break;
                }
            }
            if (blob) {
                e.preventDefault(); // é˜»æ­¢ç€è¦½å™¨é è¨­çš„ <img> æ’å…¥
                processImage(blob);
            }
        }

        function processImage(file) {
            // å£“ç¸®åœ–ç‰‡ä¸¦æ’å…¥
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // Canvas å£“ç¸® (é™åˆ¶æœ€å¤§å¯¬åº¦ 800px)
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_W = 800;
                    let w = img.width; let h = img.height;
                    
                    if (w > MAX_W) { h *= MAX_W / w; w = MAX_W; }
                    canvas.width = w; canvas.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7); // 70% å“è³ª
                    insertImageNode(dataUrl);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function insertImageNode(base64) {
            const wrapper = document.createElement('div');
            wrapper.className = 'inline-img-wrapper';
            wrapper.contentEditable = false; // ä¿è­·çµæ§‹
            wrapper.innerHTML = `
                <img src="${base64}">
                <button class="img-del-btn" onclick="deleteImg(this)">Ã—</button>
            `;

            const sel = window.getSelection();
            if (sel.rangeCount && editor.contains(sel.anchorNode)) {
                const range = sel.getRangeAt(0);
                range.deleteContents();
                range.insertNode(wrapper);
                
                // æ’å…¥å¾Œè£œä¸€å€‹æ›è¡Œï¼Œæ–¹ä¾¿ç¹¼çºŒæ‰“å­—
                const br = document.createElement('div');
                br.innerHTML = '<br>';
                range.setStartAfter(wrapper);
                range.insertNode(br);
                range.setStartAfter(br);
                sel.removeAllRanges();
                sel.addRange(range);
            } else {
                editor.appendChild(wrapper);
                editor.appendChild(document.createElement('br'));
            }
            saveCurrentDoc();
        }

        window.deleteImg = function(btn) {
            if(confirm('åˆªé™¤æ­¤åœ–ç‰‡ï¼Ÿ')) {
                btn.parentElement.remove();
                saveCurrentDoc();
            }
        };

        // --- å­—å…¸åŠŸèƒ½ ---
        let currentAudio = null;
        let currentWord = "";

        function showDict(word) {
            currentWord = word;
            document.getElementById('dict-sheet').classList.add('open');
            document.getElementById('dt-word').innerText = word;
            document.getElementById('dt-body').innerHTML = '<div style="padding:20px; text-align:center; color:#999;">æŸ¥è©¢ä¸­...</div>';
            document.getElementById('dt-phonetic').innerText = '';
            
            fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`)
                .then(r => r.json())
                .then(data => {
                    const item = data[0];
                    const ph = item.phonetic || (item.phonetics.find(p=>p.text)?.text) || '';
                    document.getElementById('dt-phonetic').innerText = ph;
                    
                    const audioObj = item.phonetics.find(p=>p.audio && p.audio !== '');
                    currentAudio = audioObj ? audioObj.audio : null;

                    let html = '';
                    // å–å‰å…©å€‹è©æ€§
                    item.meanings.slice(0, 2).forEach(m => {
                        html += `<div class="dict-def-item">
                            <span class="dict-pos">${m.partOfSpeech}.</span>
                            ${m.definitions[0].definition}
                        </div>`;
                    });
                    document.getElementById('dt-body').innerHTML = html;
                })
                .catch(() => {
                    document.getElementById('dt-body').innerHTML = '<div style="padding:20px; text-align:center;">æŸ¥ç„¡çµæœ</div>';
                });
        }

        function closeDict() { document.getElementById('dict-sheet').classList.remove('open'); }
        
        function playAudio() {
            if (currentAudio) {
                const p = document.getElementById('audio-player');
                p.src = currentAudio; p.play();
            } else {
                alert('ç„¡ç™¼éŸ³æª”');
            }
        }

        function searchExternal() {
            window.open(`https://www.google.com/search?tbm=isch&q=${currentWord}`, '_blank');
        }

        // --- æ¨¡å¼èˆ‡ UI ---
        function setPhase(p) {
            document.body.className = `mode-${p}`;
            document.querySelectorAll('.stage-btn').forEach(b => b.classList.remove('active', 'active-3'));
            const btn = document.getElementById(`btn-p${p}`);
            btn.classList.add('active'); 
            if(p===3) btn.classList.add('active-3');

            editor.contentEditable = (p === 1);
            if(p !== 1) {
                // éš±è—æ‰€æœ‰ç­”æ¡ˆ
                document.querySelectorAll('.cloze-word').forEach(el => el.classList.remove('revealed'));
            }
        }

        function getMode() {
            if (document.body.classList.contains('mode-1')) return 1;
            if (document.body.classList.contains('mode-2')) return 2;
            return 3;
        }

        function toggleSidebar(forceState) {
            const sb = document.getElementById('sidebar');
            const ov = document.querySelector('.sidebar-overlay');
            if (typeof forceState === 'boolean') {
                forceState ? sb.classList.add('open') : sb.classList.remove('open');
                forceState ? ov.classList.add('show') : ov.classList.remove('show');
            } else {
                sb.classList.toggle('open');
                ov.classList.toggle('show');
            }
        }

        // --- å‚™ä»½åŠŸèƒ½ (JSON) ---
        function exportData() {
            const str = JSON.stringify(docs);
            const blob = new Blob([str], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sandwich_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if(Array.isArray(json)) {
                        docs = json;
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(docs));
                        alert('é‚„åŸæˆåŠŸï¼');
                        location.reload();
                    }
                } catch(err) {
                    alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤');
                }
            };
            reader.readAsText(file);
        }

        // å•Ÿå‹•
        init();

    </script>
</body>
</html>
